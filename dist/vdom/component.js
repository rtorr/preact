import{SYNC_RENDER,NO_RENDER,FORCE_RENDER,ASYNC_RENDER,ATTR_KEY}from'../constants.js';import options from'../options.js';import{extend}from'../util.js';import{enqueueRender}from'../render-queue.js';import{getNodeProps}from'./index.js';import{diff,mounts,diffLevel,flushMounts,recollectNodeTree,removeChildren}from'./diff.js';import{createComponent,collectComponent}from'./component-recycler.js';import{removeNode}from'../dom/index.js';export function setComponentProps(a,b,d,e,f){a._disable||(a._disable=!0,(a.__ref=b.ref)&&delete b.ref,(a.__key=b.key)&&delete b.key,!a.base||f?a.componentWillMount&&a.componentWillMount():a.componentWillReceiveProps&&a.componentWillReceiveProps(b,e),e&&e!==a.context&&(!a.prevContext&&(a.prevContext=a.context),a.context=e),!a.prevProps&&(a.prevProps=a.props),a.props=b,a._disable=!1,d!==NO_RENDER&&(d!==SYNC_RENDER&&!1===options.syncComponentUpdates&&a.base?enqueueRender(a):renderComponent(a,SYNC_RENDER,f)),a.__ref&&a.__ref(a))}export function renderComponent(a,b,d,e){if(a._disable)return;let q,r,s,f=a.props,g=a.state,h=a.context,i=a.prevProps||f,j=a.prevState||g,k=a.prevContext||h,l=a.base,m=a.nextBase,n=l||m,o=a._component,p=!1;if(l&&(a.props=i,a.state=j,a.context=k,b!==FORCE_RENDER&&a.shouldComponentUpdate&&!1===a.shouldComponentUpdate(f,g,h)?p=!0:a.componentWillUpdate&&a.componentWillUpdate(f,g,h),a.props=f,a.state=g,a.context=h),a.prevProps=a.prevState=a.prevContext=a.nextBase=null,a._dirty=!1,!p){q=a.render(f,g,h),a.getChildContext&&(h=extend(extend({},h),a.getChildContext()));let v,w,u=q&&q.nodeName;if('function'==typeof u){let x=getNodeProps(q);r=o,r&&r.constructor===u&&x.key==r.__key?setComponentProps(r,x,SYNC_RENDER,h,!1):(v=r,a._component=r=createComponent(u,x,h),r.nextBase=r.nextBase||m,r._parentComponent=a,setComponentProps(r,x,NO_RENDER,h,!1),renderComponent(r,SYNC_RENDER,d,!0)),w=r.base}else s=n,v=o,v&&(s=a._component=null),(n||b===SYNC_RENDER)&&(s&&(s._component=null),w=diff(s,q,h,d||!l,n&&n.parentNode,!0));if(n&&w!==n&&r!==o){let x=n.parentNode;x&&w!==x&&(x.replaceChild(w,n),!v&&(n._component=null,recollectNodeTree(n,!1)))}if(v&&unmountComponent(v),a.base=w,w&&!e){let x=a,y=a;for(;y=y._parentComponent;)(x=y).base=w;w._component=x,w._componentConstructor=x.constructor}}if(!l||d?mounts.unshift(a):!p&&(flushMounts(),a.componentDidUpdate&&a.componentDidUpdate(i,j,k),options.afterUpdate&&options.afterUpdate(a)),null!=a._renderCallbacks)for(;a._renderCallbacks.length;)a._renderCallbacks.pop().call(a);diffLevel||e||flushMounts()}export function buildComponentFromVNode(a,b,d,e){let f=a&&a._component,g=f,h=a,i=f&&a._componentConstructor===b.nodeName,j=i,k=getNodeProps(b);for(;f&&!j&&(f=f._parentComponent);)j=f.constructor===b.nodeName;return f&&j&&(!e||f._component)?(setComponentProps(f,k,ASYNC_RENDER,d,e),a=f.base):(g&&!i&&(unmountComponent(g),a=h=null),f=createComponent(b.nodeName,k,d),a&&!f.nextBase&&(f.nextBase=a,h=null),setComponentProps(f,k,SYNC_RENDER,d,e),a=f.base,h&&a!==h&&(h._component=null,recollectNodeTree(h,!1))),a}export function unmountComponent(a){options.beforeUnmount&&options.beforeUnmount(a);let b=a.base;a._disable=!0,a.componentWillUnmount&&a.componentWillUnmount(),a.base=null;let d=a._component;d?unmountComponent(d):b&&(b[ATTR_KEY]&&b[ATTR_KEY].ref&&b[ATTR_KEY].ref(null),a.nextBase=b,removeNode(b),collectComponent(a),removeChildren(b)),a.__ref&&a.__ref(null)}